\documentclass{article}
\usepackage{fontspec}
\usepackage{jim,amsmath}
\usepackage[french]{babel}
\usepackage{listings}
\usepackage{diagbox}
\usepackage{caption}
\usepackage{booktabs}
\usepackage{microtype}
%\usepackage{pxfonts}
\usepackage{graphicx}
\usepackage{tikz}
\DeclareCaptionType{scenario}[Scénario]
% Title.
% ------
\title{Écriture et exécution répartie de scénarios interactifs}

\threeauthors
  {Auteur 1} {Organisme \\ Adresse électronique}
  {Auteur 2} {Organisme \\ Adresse électronique}
  {Auteur 3} {Organisme \\ Adresse électronique}

\begin{document}
\maketitle
\begin{abstract}
Le résumé doit être placé en haut de la colonne gauche et doit contenir entre 150 et 200 mots.
\end{abstract}
\section{Introduction}
\subsection{Contexte}

\subsubsection{Horloges}
\subsubsection{Synchronisation de médias}
- pas pour l'instant... doivent être au même endroit sur la même machine.
Ableton Link ? Netjack ?
\subsection{État de l'art}
\subsubsection{Rappel du modèle d'i-score}
Vocabulaire. Prendre article SMC.
\subsubsection{Répartition à l'édition}
\subsubsection{Répartition à l'exécution}
\subsubsection{Lien entre la répartition à l'édition et la répartition à l'exécution}

\section{Taxonomie et étude de cas}
-> installation en son réparti ?

- Problème de la latence entre i-score et raspberry, + utilisation de bande passante.

- Cas des applis de téléphone : un objet qui s'exécute sur plusieurs machines en parallèle dont on veut aggréger les résultats

- Approche alternative avec application mobile.

- Lister les cas. D'abord non interactif (partage uniquement des processus), puis interactif.

\section{Approche}
- Groupe, client

- Maître-esclave

- Dire qu'on peut toujours le faire "à la main" dans i-score, mais que c'est long et complexe.

- La manière dont la répartition se fait dépend du processus.

\subsection{Édition}
- Partage de file undo - redo

- Un seul "document" logique sur lequel tout le monde travail. Comme google docs.

\subsection{Exécution}
\subsubsection{Processus de contenu}
Automation, mapping, JS, audio...

Le processus s'exécute tel quel pour toutes les machines auquel il est assigné, 
et ne s'exécute pas pour les autres.

\subsubsection{Processus Scenario}
Trois niveaux de synchronisation : 

\begin{itemize}
    \item Aucune synchronisation : les machines n'étant pas associées à ce processus ne l'exécutent pas, celles qui y sont associées l'exécutent toutes de manière indépendante. Note : scénarios hiérarchiques ? 
    \item Synchronisation partielle : il peut y avoir plusieurs lignes temporelles dans un même scénario qui doivent se resynchroniser. Les annotations donnent l'emplacement d'exécution, et de vérification des expressions.
    \item Synchronisation complète : il n'y a qu'une seule "ligne temporelle" pour toutes les machines. Les annotations de machines indiquent l'emplacement d'exécution.
\end{itemize}

Problème transverse : ignorer ou non la hiérarchie ? 

Différence entre synchro partielle et complète : 
\begin{itemize}
    \item Exécution des triggers
    \item Validité des conditions
    \item Changement de vitesse d'exécution des contraintes temporelles
\end{itemize}

Dans tous les cas, cela se fait au niveau des groupes, et il peut y avoir plusieurs machines par groupe.
Donc il faut un méchanisme de décision au niveau du groupe.
-> pourquoi ne pas avoir la même chose au niveau des mappings (et pour tout ce qui n'est pas fixé de manière générale ?)

\subsubsection{Horloges}

Synchro d'horloges de deux machines dont une qui ralenti, si elles exécutent le même 
scénario ? Il faut les recaler régulièrement. 

Possibilité : externe (NTP, etc) ou interne.

Recaler dès qu'on accumule du retard ?
On peut introduire un recalage sur la master clock entre chaque tick.

\subsection{Introduction de primitives réparties dans i-score}

\subsubsection{Répartition des contenus dans le cas non-interactif}
\begin{figure}[h]
    \centering
    \begin{tikzpicture}
    \input{scenarios/simple.tex}
    \end{tikzpicture}
    \captionof{scenario}{Deux contraintes temporelles se suivent}
    \label{scenar.simple}
\end{figure}

\begin{itemize}
    \item Cas partagé : toutes les machines vont exécuter l'ensemble du scénario en parallèle.
    \item Cas synchronisé : chaque machine va exécuter une partie du scénario : par exemple, une machine exécute $C_1$ et une autre $C_2$.
\end{itemize}

On sépare donc les objets structurants, des objets possédant des données (par exemple, une automation).


\subsubsection{Répartition des contenus dans le cas interactif}
\begin{figure}[h]
    \centering
    \begin{tikzpicture}
    \input{scenarios/general.tex}
    \end{tikzpicture}
    \captionof{scenario}{Interactions et conditions}
    \label{scenar.general}
\end{figure}

Un problème de synchronisation

- On souhaite modifier le moins possible le modèle pour les utilisateurs

- Notion de groupe

- Problème des devices

- implémentation : on rajoute des délais dans les expressions.

Cas synchrone : 
* Sous-expression devient vraie
* Expression fixe une date possible pour le réseau et notifie les autres puis se fixe au bon délai.

Cas asynchrone : 
* Sous-expression devient vraie
* Expression envoie un message aux autres et se lance immédiatement.
Il faut définir sur quelle machine l'expression est validée.

- Cas de la borne max : trigger, bof

Groupes pour triggers : problème du consensus. Voir notamment Paxos, Raft... 
% https://github.com/apache/kudu

Pour l'instant : group leader ? ou bien tous se communiquent l'information et prennent la décision en fonction de cette information ?

- Latence : prendre moyenne et écart-type sur les dix dernières valeurs ? Ou juste dernière valeur ?
En LAN gigabit on est en général < à une milliseconde.

- Pour l'édition temps-réel, on doit permettre d'appliquer des "filtres" (par exemple qui vont rajouter une sur-expression, etc)
\subsection{Méchanismes de synchronisation}
- Cas possibles : 

\begin{lstlisting}
C1 ---t--- C3
C2 ---|--- C4
\end{lstlisting}
* Mode free ou synchronisé : pour chaque client ? 

Cas 1 : 
\begin{lstlisting}
C1 ---t--- C3
\end{lstlisting}
C1 libre, C3 libre : dès que t est vrai, un message est envoyé au master qui envoie à C3 le trigger. C1 s'est déjà arrêté.
Voire, ils peuvent se trig eux même en asynchrone.

C1 synchro, C3 synchro : dès que t est vrai, C1 calcule la date minimale à laquelle C3 peut être notifié, envoie le message et fixe ce temps de son côté.

Cas 2 : 
\begin{lstlisting}
C1 ---t--- C3
C2 ---|
\end{lstlisting}

* Synchronisation de la fin

* Synchronisation du début de la suite

En pratique, on n'implémente que la possibilité de synchro / désynchro toute une time node ; dire qu'une granularité plus fine est possible mais que l'intérêt n'apparaît pas en pratique dans les applications (et complexifierait l'UI pour rien).

Question principale : pour un time-node, comment choisit-on sur quelle machine une condition doit être vérifiée ? Possibilité de conditions groupées : faut-il que ce soit interne au formalisme (i.e. une case à cocher) ou externe (on dit explicitement \lstinline|machine1:/truc && machine2:/truc|)

\subsubsection{Cas ou il y a plusieurs machines dans un groupe}
Attributs d'une expression : 
\begin{itemize}
    \item Qui vérifie cette expression : chaque machine individuellement, toutes les machines d'un groupe, n'importe quelle machine d'un groupe 
\end{itemize}

Séparer les expressions et les time-node : notamment pour le cas de la borne max, ou on doit avertir d'autres machines par la suite.

Deux axes : 
\begin{figure}[h]
\begin{tabular}{c|c|c}
\diagbox{Décision}{Sync} & Oui & Non \\
\midrule
Locale & 1 & 2 \\
\midrule
Partagée & 3 & 4\\        
\end{tabular}
\end{figure}
\begin{itemize}
    \item Décision locale : Pour un trigger, soit tout le scénario est local (donc même contrainte avant / après et certains ordis n'exécutent pas du tout ce scénario), soit le premier à avoir un résultat avertit les suivants.
    \item Décision partagée : tous les éléments d'un groupe doivent prendre une décision avec une politique donnée : soit tous doivent vérifier la condition, soit un seul.
    \item Décision synchrone : On veut que les éléments s'arrêtent et démarrent le plus proche possible d'une même date en wall clock.
    \item Décision asynchrone : On veut que les éléments s'arrêtent et démarrent le plus vite possible dès qu'une information est disponible.
\end{itemize}

\begin{enumerate}
\item Décision locale synchrone : pas de sens
\item Décision locale asynchrone : pas de sens... 
\item Décision partagée synchrone : toutes les machines attendent qu'un unique choix soit effectué pour le résultat de l'expression
\item Décision partagée asynchrone
\end{enumerate}

Possibilité : synchronisation via démon externe (PTP, NTP...), mais pas toujours possible (on ne peut pas supposer que l'utilisateur a les droits pour changer l'horloge sur sa machine).

Synchronous ethernet

Ableton Link : synchro sur les ticks musicaux 

Avoir une horloge propre à i-score ? Mais du coup maintenant il faut la synchroniser à l'horloge système. 

Ce qu'on fait : ping régulier vers chaque client (toutes les 100 millisecondes)

Quand quelque chose doit se synchroniser, on dit à chaque machine à quel instant il est supposé arriver par rapport à son horloge système.

Extension via système de composants

Quand un client reçoit un ordre pour un timenode à t, il l'applique dès que t <= local(t) (modulo un tick?)

On ne synchronise qu'à chaque point d'entrée / de sortie d'un groupe de contraintes / time nodes
\subsection{Extension des possibilités d'écriture}
* Paramètres partagés

* Pattern matching sur addresses 

\section{Performance}
- Comparaison de l'algorithme "simple" et de l'algorithme avec retard

\section{Citations}

Toutes les références bibliographiques des citations devront être listées dans la section "\textsc{References}", numérotées et en ordre alphabétique. Toutes les références  listées devront être citées dans le texte. Quand  vous vous référez au document dans le texte, précisez son numéro \cite{Author:00}.

\begin{thebibliography}{2}

\bibitem {Author:00} Author, E.
''Titre du papier'',
{\it Proceedings of the International Symposium on Music Information
Retrieval}, Plymouth, USA, 2000.

\bibitem{Someone:02} Untel, A.
{\it  Titre du livre}.
L'Armada, Paris, 2005.

\end{thebibliography}

\end{document}
